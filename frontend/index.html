<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visual Product Matcher ‚Äî Advanced</title>
    <style>
        :root{
            --bg-1: #0f172a;
            --card: rgba(255,255,255,0.98);
            --muted: #6b7280;
            --accent-1: #2c5530;
            --accent-2: #4a7c59;
            --glass: rgba(255,255,255,0.06);
            --glass-2: rgba(255,255,255,0.9);
            --glass-border: rgba(255,255,255,0.06);
            --success: #16a34a;
            --danger: #dc3545;
            --radius: 14px;
            --transition: 240ms cubic-bezier(.2,.9,.2,1);
            --max-width: 1400px;
        }

        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%}
        body{
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: linear-gradient(180deg,#0f172a 0%, #0b1220 100%);
            color: #0b1220;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            padding:28px;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;
        }

        .container{width:100%;max-width:var(--max-width)}

        /* Header */
        .header{
            background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
            padding:28px;border-radius:20px;margin-bottom:22px;box-shadow:0 12px 40px rgba(2,6,23,0.6);
            display:flex;align-items:center;gap:20px;justify-content:space-between;backdrop-filter:blur(6px);
        }

        .brand{
            display:flex;flex-direction:column;gap:6px
        }
        .brand h1{font-size:1.45rem;color:#0b1220;margin:0;letter-spacing:-0.2px}
        .brand p{color:var(--muted);font-size:0.95rem}

        .status{padding:10px 14px;border-radius:12px;font-weight:600}
        .status.connected{background:linear-gradient(90deg, rgba(34,197,94,0.08), rgba(56,189,248,0.03));color:var(--success);border:1px solid rgba(34,197,94,0.08)}
        .status.disconnected{background:rgba(220,53,69,0.06);color:var(--danger);border:1px solid rgba(220,53,69,0.06)}

        /* Upload section */
        .upload-section{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:26px;border-radius:18px;display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start}

        .upload-left{padding:6px}
        .upload-left h2{color:var(--accent-1);margin-bottom:8px}
        .upload-left p{color:var(--muted);margin-bottom:12px}

        .upload-options{display:grid;grid-template-columns:1fr 1fr;gap:14px}

        .upload-box{
            border-radius:12px;padding:18px;position:relative;border:2px dashed var(--glass-border);background:linear-gradient(180deg, rgba(74,124,89,0.02), transparent);cursor:pointer;transition:all var(--transition);
            display:flex;flex-direction:column;gap:8px;align-items:flex-start;
        }
        .upload-box:hover{transform:translateY(-6px);box-shadow:0 16px 40px rgba(8,15,30,0.45)}
        .upload-box.drag-over{border-color:var(--accent-2);background:linear-gradient(180deg, rgba(74,124,89,0.06), rgba(74,124,89,0.02));}

        /* removed emoji icons ‚Äî user requested no icons for upload/image */
        .upload-box .title{font-weight:700;color:var(--accent-1)}
        .upload-box .desc{font-size:0.92rem;color:var(--muted)}

        .url-input-container{display:flex;gap:10px;width:100%}
        .url-input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(11,17,32,0.06);font-size:0.95rem}
        .url-input:focus{outline:none;box-shadow:0 6px 22px rgba(14,22,32,0.08);border-color:var(--accent-1)}

        .btn{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:all var(--transition)}
        .btn:hover{transform:translateY(-3px)}
        .btn.secondary{background:linear-gradient(90deg,#6c757d,#868e96)}

        /* preview */
        .preview-section{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
        .preview-wrap{width:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border-radius:14px;padding:10px;border:1px solid rgba(255,255,255,0.03)}
        .preview-image{max-width:320px;max-height:320px;object-fit:contain;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);display:none}

        /* filters & controls */
        .controls{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
        .filters{display:flex;gap:16px;align-items:center}
        .filter-group{display:flex;flex-direction:column;gap:8px}
        .filter-group label{font-weight:700;color:var(--accent-1);font-size:0.9rem}
        .filter-group select{padding:10px;border-radius:8px;border:1px solid rgba(11,17,32,0.06)}

        /* results area */
        .analysis-results{margin-top:18px;padding:18px;border-radius:12px;background:var(--card);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
        .results-info{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.96),rgba(255,255,255,0.9));box-shadow:0 8px 30px rgba(2,6,23,0.5)}

        .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px;margin-top:18px}
        .product-card{background:linear-gradient(180deg,rgba(255,255,255,0.96),rgba(255,255,255,0.9));padding:16px;border-radius:12px;display:flex;flex-direction:column;gap:10px;border:1px solid rgba(11,17,32,0.04);transition:transform var(--transition), box-shadow var(--transition)}
        .product-card:hover{transform:translateY(-12px);box-shadow:0 30px 60px rgba(2,6,23,0.6)}
        .product-image{width:100%;height:170px;object-fit:cover;border-radius:10px;flex-shrink:0}

        .similarity-badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;font-size:0.85rem}
        .product-name{font-weight:800;color:var(--accent-1);font-size:1rem}
        .product-category{font-size:0.85rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px}
        .product-price{font-weight:800;color:var(--accent-1)}
        .product-description{font-size:0.9rem;color:#374151}

        .match-reasons{background:linear-gradient(180deg, rgba(74,124,89,0.06), rgba(74,124,89,0.02));padding:10px;border-radius:8px}
        .match-reason{border-left:3px solid var(--accent-2);padding-left:10px;margin-bottom:6px;color:var(--accent-1);font-weight:600}

        .loading{display:none;text-align:center;padding:22px}
        .spinner{width:42px;height:42px;border-radius:50%;border:4px solid rgba(0,0,0,0.06);border-top:4px solid var(--accent-1);animation:spin 1s linear infinite;margin:0 auto 12px}
        @keyframes spin{to{transform:rotate(360deg)}}

        .error{display:none;background:rgba(220,53,69,0.06);color:var(--danger);padding:12px;border-radius:8px;border-left:4px solid rgba(220,53,69,0.12);margin-top:12px}

        /* responsive */
        @media (max-width:980px){
            .upload-section{grid-template-columns:1fr;}
            .upload-options{grid-template-columns:1fr}
            .header{flex-direction:column;align-items:flex-start;gap:10px}
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="brand">
                <h1>Visual Product Matcher</h1>
                <p>Upload an image or paste a URL to find visually similar products</p>
            </div>
            <div id="apiStatus" class="status">üîç Checking API Connection...</div>
        </div>

        <div class="upload-section">
            <div class="upload-left">
                <h2>Upload Your Product Image</h2>
                <p>Drag & drop an image, browse files, or paste an image URL. Icons have been removed for a cleaner UI.</p>

                <div class="upload-options">
                    <!-- Drag & Drop Upload -->
                    <div class="upload-box" id="dropZone" tabindex="0" aria-label="Drop image here or click to browse">
                        <div class="title">Drag & Drop</div>
                        <div class="desc">Drop your image here or click to choose a file</div>
                        <input type="file" id="fileInput" accept="image/*" style="display:none">
                        <div style="margin-top:auto;width:100%;display:flex;justify-content:flex-end;">
                            <button class="btn" onclick="document.getElementById('fileInput').click();event.stopPropagation();">Browse Files</button>
                        </div>
                    </div>

                    <!-- URL Upload -->
                    <div class="upload-box" id="urlBox">
                        <div class="title">Image URL</div>
                        <div class="desc">Paste an image URL and click "Use URL"</div>
                        <div class="url-input-container" style="margin-top:8px;">
                            <input type="url" id="urlInput" class="url-input" placeholder="https://example.com/image.jpg">
                            <button class="btn" onclick="searchWithUrl(event);">Use URL</button>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <div style="display:flex;gap:10px;align-items:center">
                        <button class="btn" onclick="searchWithCurrentImage()">üîç Search Similar Products</button>
                        <button class="btn secondary" onclick="loadAllProducts()">üì¶ Show All Products</button>
                    </div>

                    <div class="filters" style="margin-left:auto">
                        <div class="filter-group">
                            <label>Category</label>
                            <select id="categoryFilter" onchange="filterProducts()">
                                <option value="all">All Categories</option>
                                <option value="electronics">Electronics</option>
                                <option value="footwear">Footwear</option>
                                <option value="clothing">Clothing</option>
                                <option value="home">Home & Kitchen</option>
                                <option value="sports">Sports & Fitness</option>
                                <option value="accessories">Accessories</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label>Min Similarity</label>
                            <select id="similarityFilter" onchange="filterProducts()">
                                <option value="0">Any</option>
                                <option value="30">30%+</option>
                                <option value="50">50%+</option>
                                <option value="70">70%+</option>
                                <option value="80">80%+</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label>Sort</label>
                            <select id="sortFilter" onchange="sortProducts()">
                                <option value="similarity">Similarity (High to Low)</option>
                                <option value="price-low">Price (Low to High)</option>
                                <option value="price-high">Price (High to Low)</option>
                                <option value="name">Product Name</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="resultsInfo" class="results-info" style="display:none"></div>
                <div id="error" class="error" role="alert" style="display:none"></div>
            </div>

            <div class="preview-section">
                <div class="preview-wrap">
                    <img id="previewImage" class="preview-image" alt="Preview" />
                </div>
                <button id="removeImageBtn" class="btn secondary" style="margin-top:10px;display:none" onclick="clearPreview()">Remove Image</button>

                <div style="width:100%;display:flex;justify-content:center;margin-top:12px">
                    <div id="loading" class="loading" style="display:none">
                        <div class="spinner"></div>
                        <div style="color:var(--muted)">Analyzing your image...</div>
                    </div>
                </div>

            </div>
        </div>

        <div id="analysisResults" class="analysis-results" style="display:none">
            <h3 style="color:var(--accent-1);margin-bottom:10px">Image Analysis Results</h3>
            <div id="analysisContent"></div>
        </div>

        <div id="productsContainer" class="products-grid"></div>

    </div>

    <script>
        let allProducts = [];
        let currentImageData = null;

        function initializeDragDrop(){
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('dragover', (e)=>{e.preventDefault();dropZone.classList.add('drag-over');});
            dropZone.addEventListener('dragleave', ()=>dropZone.classList.remove('drag-over'));

            dropZone.addEventListener('drop', (e)=>{
                e.preventDefault();dropZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if(files && files[0] && files[0].type && files[0].type.startsWith('image/')){
                    handleFileSelect(files[0]);
                } else {
                    showError('Please drop a valid image file');
                }
            });

            // Click to open file picker
            dropZone.addEventListener('click', ()=>fileInput.click());

            fileInput.addEventListener('change', (e)=>{ if(e.target.files.length>0) handleFileSelect(e.target.files[0]); });

            // keyboard accessibility for drop zone
            dropZone.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { fileInput.click(); e.preventDefault(); } });
        }

        function handleFileSelect(file){
            if(!file.type || !file.type.startsWith('image/')){ showError('Please select a valid image file'); return; }
            const reader = new FileReader();
            reader.onload = (e)=>{
                currentImageData = { type:'file', file, preview:e.target.result };
                showPreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function showPreview(src){
            const preview = document.getElementById('previewImage');
            preview.src = src;
            preview.style.display = 'block';
            hideError();
            // show remove button when an image is previewed
            const removeBtn = document.getElementById('removeImageBtn');
            if(removeBtn) removeBtn.style.display = 'inline-block';
        }

        async function searchWithCurrentImage(){
            if(!currentImageData){ showError('Please upload an image or enter a URL first'); return; }
            showLoading(); hideError();
            try{
                let response;
                if(currentImageData.type === 'file'){
                    const formData = new FormData();
                    formData.append('image', currentImageData.file);
                    response = await fetch('http://localhost:5000/api/search', { method:'POST', body:formData });
                } else if(currentImageData.type === 'url'){
                    // try to fetch the image and POST blob ‚Äî this may fail due to CORS on remote hosts
                    try{
                        const imageResponse = await fetch(currentImageData.url);
                        if(!imageResponse.ok) throw new Error('Failed to download image (CORS or network)');
                        const blob = await imageResponse.blob();
                        const formData = new FormData();
                        formData.append('image', blob, 'image.jpg');
                        response = await fetch('http://localhost:5000/api/search', { method:'POST', body:formData });
                    } catch(err){
                        throw new Error('Unable to fetch image from URL due to CORS or network restrictions. Try downloading the image and uploading instead.');
                    }
                }

                if(!response) throw new Error('No response from search request');
                const data = await response.json();
                if(data && data.success){
                    allProducts = Array.isArray(data.data) ? data.data : [];
                    // normalize similarity to numbers 0..1
                    allProducts = allProducts.map(p => ({ ...p, similarity: sanitizeSimilarity(p.similarity) }));
                    displayProducts(allProducts);
                    showAnalysisResults(data.analysis);
                    showResultsInfo(`Found ${data.total ?? allProducts.length} similar products`);
                } else {
                    throw new Error((data && data.message) || 'Search failed');
                }
            } catch(err){
                showError('Search failed: ' + err.message);
            } finally{ hideLoading(); }
        }

        async function searchWithUrl(e){
            if(e) e.preventDefault();
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            if(!url){ showError('Please enter an image URL'); return; }
            try{ new URL(url); } catch{ showError('Please enter a valid URL'); return; }

            showLoading(); hideError();
            try{
                // We'll attempt to download then post ‚Äî note: many hosts block cross-origin requests.
                const imageResponse = await fetch(url);
                if(!imageResponse.ok) throw new Error('Failed to download image (CORS or 404)');
                const blob = await imageResponse.blob();
                const formData = new FormData();
                formData.append('image', blob, 'image.jpg');

                const response = await fetch('http://localhost:5000/api/search', { method:'POST', body:formData });
                const data = await response.json();
                if(data && data.success){
                    currentImageData = { type:'url', url, preview:url };
                    showPreview(url);
                    allProducts = Array.isArray(data.data) ? data.data : [];
                    allProducts = allProducts.map(p => ({ ...p, similarity: sanitizeSimilarity(p.similarity) }));
                    displayProducts(allProducts);
                    showAnalysisResults(data.analysis);
                    showResultsInfo(`Found ${data.total ?? allProducts.length} similar products`);
                } else {
                    throw new Error((data && data.message) || 'Search failed');
                }
            } catch(err){
                showError('URL search failed: ' + err.message);
            } finally{ hideLoading(); }
        }

        async function loadAllProducts(){
            showLoading(); hideError();
            try{
                const response = await fetch('http://localhost:5000/api/products');
                if(!response.ok) throw new Error('Failed to contact products API');
                const data = await response.json();
                if(data && data.success){
                    allProducts = (Array.isArray(data.data) ? data.data : []).map(p=>({ ...p, similarity: sanitizeSimilarity(p.similarity ?? 0.1) }));
                    displayProducts(allProducts);
                    hideAnalysisResults();
                    showResultsInfo(`Showing all ${data.total ?? allProducts.length} products`);
                } else {
                    throw new Error((data && data.message) || 'Failed to load products');
                }
            } catch(err){
                showError('Failed to load products: ' + err.message);
            } finally{ hideLoading(); }
        }

        function sanitizeSimilarity(value){
            // Accept similarity in either 0..1 or 0..100 formats and clamp
            let v = Number(value);
            if(isNaN(v)) return 0;
            if(v > 1 && v <= 100) v = v / 100;
            if(v > 1) v = 1;
            if(v < 0) v = 0;
            return v;
        }

        function filterProducts(){
            const category = document.getElementById('categoryFilter').value;
            const minSimilarity = (parseInt(document.getElementById('similarityFilter').value) / 100) || 0;
            let filtered = allProducts.filter(product => (sanitizeSimilarity(product.similarity) >= minSimilarity));
            if(category !== 'all'){
                filtered = filtered.filter(product => (product.category || '').toString().toLowerCase() === category.toLowerCase());
            }
            displayProducts(filtered);
        }

        function sortProducts(){
            const sortBy = document.getElementById('sortFilter').value; let sorted = [...allProducts];
            switch(sortBy){
                case 'price-low': sorted.sort((a,b)=>Number(a.price||0)-Number(b.price||0)); break;
                case 'price-high': sorted.sort((a,b)=>Number(b.price||0)-Number(a.price||0)); break;
                case 'name': sorted.sort((a,b)=>(a.name||'').localeCompare((b.name||''))); break;
                case 'similarity': default: sorted.sort((a,b)=>sanitizeSimilarity(b.similarity)-sanitizeSimilarity(a.similarity)); break;
            }
            displayProducts(sorted);
        }

        function displayProducts(products){
            const container = document.getElementById('productsContainer');
            if(!products || products.length === 0){
                container.innerHTML = `\n                    <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">\n                        <div style="font-size:3rem;margin-bottom:20px;">üîç</div>\n                        <h3>No products found</h3>\n                        <p>Try adjusting filters or upload a different image.</p>\n                    </div>`;
                return;
            }

            container.innerHTML = products.map(product => {
                const sim = Math.round(sanitizeSimilarity(product.similarity) * 100);
                const imageUrl = product.imageUrl || product.image || 'https://via.placeholder.com/300x200?text=Image+Not+Found';
                return `
                    <div class="product-card">
                        <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(product.name||'Product')}" class="product-image" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Not+Found'">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div style="display:flex;flex-direction:column">
                                <div class="product-name">${escapeHtml(product.name||'Untitled')}</div>
                                <div class="product-category">${escapeHtml(product.category||'Uncategorized')}</div>
                            </div>
                            <div class="similarity-badge">${sim}%</div>
                        </div>
                        <div class="product-price">$${escapeHtml((product.price ?? '').toString())}</div>
                        <div class="product-description">${escapeHtml(product.description || '')}</div>
                        ${Array.isArray(product.matchReasons) && product.matchReasons.length>0 ? `
                            <div class="match-reasons">
                                <strong>Match Reasons:</strong>
                                ${product.matchReasons.map(r=>`<div class="match-reason">${escapeHtml(r)}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function showAnalysisResults(analysis){
            const analysisDiv = document.getElementById('analysisResults');
            const contentDiv = document.getElementById('analysisContent');
            if(!analysis || (!analysis.detectedLabels && !analysis.detectedObjects && !analysis.dominantColors)){
                analysisDiv.style.display = 'none'; return;
            }
            let html = '';
            if(analysis.detectedLabels && analysis.detectedLabels.length){
                html += `<div style="margin-bottom:12px"><h4 style="margin:0 0 8px;color:var(--accent-1)">Detected Labels</h4><div style="display:flex;gap:8px;flex-wrap:wrap">${analysis.detectedLabels.slice(0,8).map(l=>`<span style="padding:6px 8px;border-radius:999px;background:rgba(44,85,48,0.06);font-weight:600">${escapeHtml(l.description)} (${escapeHtml((l.confidence||0).toString())}%)</span>`).join('')}</div></div>`;
            }
            if(analysis.detectedObjects && analysis.detectedObjects.length){
                html += `<div style="margin-bottom:12px"><h4 style="margin:0 0 8px;color:var(--accent-1)">Detected Objects</h4><div style="display:flex;gap:8px;flex-wrap:wrap">${analysis.detectedObjects.slice(0,6).map(o=>`<span style="padding:6px 8px;border-radius:999px;background:rgba(74,124,89,0.06);font-weight:600">${escapeHtml(o.name)} (${escapeHtml((o.confidence||0).toString())}%)</span>`).join('')}</div></div>`;
            }
            if(analysis.dominantColors && analysis.dominantColors.length){
                html += `<div style="margin-bottom:6px"><h4 style="margin:0 0 8px;color:var(--accent-1)">Dominant Colors</h4><div style="display:flex;gap:8px;flex-wrap:wrap">${analysis.dominantColors.slice(0,5).map(c=>`<div style="width:38px;height:28px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:${escapeHtml(c.hex)}" title="${escapeHtml(c.hex)}"></div>`).join('')}</div></div>`;
            }
            contentDiv.innerHTML = html;
            analysisDiv.style.display = 'block';
        }

        function hideAnalysisResults(){ document.getElementById('analysisResults').style.display = 'none'; }

        function showResultsInfo(message){ const info = document.getElementById('resultsInfo'); info.innerHTML = `<strong style="color:var(--accent-1)">${escapeHtml(message)}</strong>`; info.style.display = 'block'; }

        function showLoading(){ document.getElementById('loading').style.display = 'block'; }
        function hideLoading(){ document.getElementById('loading').style.display = 'none'; }
        function showError(message){ const e = document.getElementById('error'); e.innerHTML = `<strong>Error:</strong> ${escapeHtml(message)}`; e.style.display = 'block'; }
        function hideError(){ document.getElementById('error').style.display = 'none'; }

        // check API status and handle missing response
        async function checkApiStatus(){
            const el = document.getElementById('apiStatus');
            try{
                const response = await fetch('http://localhost:5000/api/health');
                if(!response.ok) throw new Error('API returned ' + response.status);
                const data = await response.json();
                el.className = 'status connected';
                el.textContent = `‚úÖ API Connected | ${data.products ?? 'N/A'} Products | Enhanced Analysis`;
            } catch(err){
                el.className = 'status disconnected';
                el.textContent = '‚ùå API Disconnected - Please start the server';
            }
        }

        // small helper to avoid XSS
        function escapeHtml(str){ if(str == null) return ''; return (''+str).replace(/[&<>"'`]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","`":"&#96;"})[s]); }

        function clearPreview(){
            const img = document.getElementById('previewImage');
            img.src = '';
            img.style.display = 'none';
            currentImageData = null;
            document.getElementById('removeImageBtn').style.display = 'none';
        }

        // init
        document.addEventListener('DOMContentLoaded', ()=>{ initializeDragDrop(); checkApiStatus(); loadAllProducts(); });

    </script>
</body>
</html>
